#!/bin/sh
# Copyright (c) 2014 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

SCRIPT="$(readlink -f $0)"
SCRIPT_DIR="$(dirname ${SCRIPT})/init.d"

DAEMON_NAME='chameleond'
UPDATER_NAME='chameleon-updater'
INITD_DIR='/etc/init.d'
CONFIG_FILE="/etc/default/${DAEMON_NAME}"
CHAMELEOND_DIR='/usr/bin'
DAEMON="${CHAMELEOND_DIR}/run_chameleond"

if [[ ! -x ${DAEMON} ]]; then
    echo "Executable ${DAEMON} not existed. Install it first." 1>&2
    exit 1
fi

update-rc.d -f ${DAEMON_NAME} remove
update-rc.d -f ${UPDATER_NAME} remove

CONFIG_TMP="$(mktemp /tmp/${DAEMON_NAME}.XXXXXX)"
cat <<END >${CONFIG_TMP}
CHAMELEOND_DIR="${CHAMELEOND_DIR}"
BUNDLE_VERSION="${BUNDLE_VERSION}"
END
mv -f "${CONFIG_TMP}" "${CONFIG_FILE}"

cp -f "${SCRIPT_DIR}/${DAEMON_NAME}" "${INITD_DIR}"
update-rc.d "${DAEMON_NAME}" defaults 92 8

cp -f "${SCRIPT_DIR}/${UPDATER_NAME}" "${INITD_DIR}"
update-rc.d "${UPDATER_NAME}" defaults 90 10

"${INITD_DIR}/${DAEMON_NAME}" restart
